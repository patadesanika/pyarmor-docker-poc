name: Obfuscate with Docker

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  obfuscate:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Create CI License file
        env:
          PYARMOR_CI_LICENSE: ${{ secrets.PYARMOR_CI_LICENSE }}
        run: |
          echo "$PYARMOR_CI_LICENSE" | base64 -d > pyarmor-ci.zip
      
      - name: Create Dockerfile
        run: |
          cat > Dockerfile << 'EOF'
          FROM python:3.12-slim
          
          WORKDIR /app
          
          # Install Pyarmor
          RUN pip install --no-cache-dir pyarmor==9.2.3
          
          # Copy files
          COPY pyarmor-ci.zip /app/
          COPY src/ /app/src/
          
          # Register license
          RUN pyarmor reg pyarmor-ci.zip && pyarmor -v
          
          # Set CI environment variables
          ENV CI=true
          ENV GITHUB_ACTIONS=true
          ENV PYARMOR_CI=1
          
          # Obfuscate
          RUN pyarmor gen -O dist src/ && ls -la dist/
          
          # Test
          RUN cd dist && python main.py
          
          CMD ["/bin/bash"]
          EOF
      
      - name: Build and Extract
        run: |
          docker build -t pyarmor-obfuscate .
          
          # Extract obfuscated files
          docker create --name temp pyarmor-obfuscate
          docker cp temp:/app/dist ./dist
          docker rm temp
          
          echo "Obfuscated files:"
          ls -la dist/
      
      - name: Upload Obfuscated Code
        uses: actions/upload-artifact@v4
        with:
          name: obfuscated-code
          path: dist/